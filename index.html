<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏ - 3 –≥—Ä—É–ø–ø—ã</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; color: #333; }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 40px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 8px; }
        .content { padding: 40px; }
        
        /* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã */
        .global-group { margin-bottom: 50px; border: 3px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
        .global-header { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white; padding: 20px 30px; cursor: pointer; display: flex; align-items: center; gap: 15px; }
        .global-header:hover { background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%); }
        .global-icon { font-size: 2em; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.2); border-radius: 10px; }
        .global-title h2 { font-size: 1.5em; margin-bottom: 5px; }
        .global-title p { opacity: 0.9; font-size: 0.9em; }
        .global-count { margin-left: auto; font-size: 2em; font-weight: bold; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px; }
        .toggle-icon { font-size: 1.5em; transition: transform 0.3s; }
        .toggle-icon.expanded { transform: rotate(180deg); }
        .global-content { background: #f9fafb; padding: 30px; max-height: 10000px; overflow: hidden; transition: max-height 0.5s ease-out; }
        .global-content.collapsed { max-height: 0; padding: 0; }
        
        /* –ü–æ–¥–≥—Ä—É–ø–ø—ã –≤–Ω—É—Ç—Ä–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö */
        .sub-group { margin-bottom: 30px; }
        .sub-header { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 8px 15px; border-radius: 8px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .sub-header:hover { transform: translateX(3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .sub-header.critical { background: linear-gradient(90deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid #dc2626; }
        .sub-header.improving { background: linear-gradient(90deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid #10b981; }
        .sub-header.stable { background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 100%); border-left: 4px solid #6b7280; }
        .sub-header.warning { background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; }
        .sub-icon { font-size: 1.3em; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .sub-title { flex: 1; text-align: center; }
        .sub-title h3 { font-size: 0.95em; margin-bottom: 0; font-weight: 600; line-height: 1.2; }
        .sub-title p { color: #666; font-size: 0.7em; margin: 0; line-height: 1.2; }
        .sub-count { font-size: 1.1em; font-weight: bold; padding: 4px 10px; background: white; border-radius: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .sub-count.critical { color: #dc2626; }
        .sub-count.improving { color: #10b981; }
        .sub-count.stable { color: #6b7280; }
        .sub-count.warning { color: #f59e0b; }
        .sub-content { overflow: hidden; transition: max-height 0.5s ease-out; }
        .sub-content.collapsed { max-height: 0; }
        
        /* –¢–∞–±–ª–∏—Ü—ã */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid #d1d5db; }
        thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        thead th { padding: 12px 10px; text-align: left; font-weight: 600; font-size: 0.9em; border: 1px solid rgba(255,255,255,0.2); }
        tbody tr { border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s; }
        tbody tr:hover { background-color: #f9fafb; }
        tbody td { padding: 10px; vertical-align: middle; border: 1px solid #e5e7eb; }
        .test-name { font-weight: 600; color: #374151; min-width: 180px; font-size: 0.9em; }
        .reference { color: #6b7280; font-size: 0.8em; }
        .value-cell { text-align: center; font-weight: 600; font-size: 0.95em; }
        .value-cell.out-of-range { color: #dc2626; font-weight: 700; }
        .value-cell.in-range { color: #059669; }
        .change-badge { display: inline-block; padding: 2px 6px; border-radius: 8px; font-size: 0.75em; font-weight: 600; margin-left: 4px; }
        .change-badge.up { background: #fee2e2; color: #dc2626; }
        .change-badge.down { background: #d1fae5; color: #059669; }
        .trend-cell { font-size: 0.8em; line-height: 1.3; max-width: 250px; }
        .trend-icon { font-size: 1.1em; margin-right: 4px; }
        .chart-mini { width: 100px; height: 35px; cursor: pointer; }
        
        .footer { text-align: center; padding: 20px; background: #f8f9fa; color: #666; font-size: 0.9em; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .chart-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
        .chart-modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 80%; max-width: 800px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px; }
        .close-modal:hover { color: #000; }
        .chart-modal-title { font-size: 1.5em; margin-bottom: 20px; color: #667eea; }
        
        @media (max-width: 768px) {
            table { font-size: 0.75em; min-width: 650px; }
            .global-header { padding: 15px 20px; }
            .global-icon { width: 45px; height: 45px; font-size: 1.6em; }
            .global-title h2 { font-size: 1.2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –ê–Ω–∞–ª–∏–∑ –¥–∏–Ω–∞–º–∏–∫–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∫—Ä–æ–≤–∏</h1>
            <p>–ü–µ—Ä–∏–æ–¥: 26.09.2025 - 28.10.2025 | –ü–∞—Ü–∏–µ–Ω—Ç: Mama</p>
        </div>
        
        <div class="content" id="mainContent">
            <!-- –ì—Ä—É–ø–ø—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
        
        <div class="footer">
            <p><strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> 28.10.2025 | <strong>–í—Å–µ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π:</strong> 50</p>
        </div>
    </div>
    
    <div id="chartModal" class="chart-modal">
        <div class="chart-modal-content">
            <span class="close-modal">&times;</span>
            <h3 class="chart-modal-title" id="modalTitle"></h3>
            <canvas id="modalChart" style="max-height: 400px;"></canvas>
        </div>
    </div>
    
    <script>
        // –î–∞–Ω–Ω—ã–µ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–º –≥—Ä—É–ø–ø–∞–º
        const allTests = {
            oak: [
                {name: "–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã (RBC)", unit: "—Ö10^12/L", reference: "3.8 - 5.3", refMin: 3.8, refMax: 5.3, values: [null, 4.31, 4.40, 4.41]},
                {name: "–ì–µ–º–æ–≥–ª–æ–±–∏–Ω (Hb)", unit: "–≥/–¥–ª", reference: "11.7 - 16", refMin: 11.7, refMax: 16, values: [null, 12.1, 12.5, 12.5]},
                {name: "–ì–µ–º–∞—Ç–æ–∫—Ä–∏—Ç (Ht)", unit: "%", reference: "35 - 47", refMin: 35, refMax: 47, values: [null, 38.4, 38.8, 38.3]},
                {name: "–õ–µ–π–∫–æ—Ü–∏—Ç—ã (WBC)", unit: "x10^9/L", reference: "4 - 10", refMin: 4, refMax: 10, values: [null, 3.38, 4.75, 4.00]},
                {name: "–ù–µ–π—Ç—Ä–æ—Ñ–∏–ª—ã (%)", unit: "%", reference: "47 - 72", refMin: 47, refMax: 72, values: [null, 73.7, 74.0, 72.9]},
                {name: "–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã (%)", unit: "%", reference: "19 - 37", refMin: 19, refMax: 37, values: [null, 18.6, 18.1, 17.5]},
                {name: "–ú–æ–Ω–æ—Ü–∏—Ç—ã (%)", unit: "%", reference: "3 - 12", refMin: 3, refMax: 12, values: [null, 6.2, 6.7, 7.5]},
                {name: "–≠–æ–∑–∏–Ω–æ—Ñ–∏–ª—ã (%)", unit: "%", reference: "1 - 5", refMin: 1, refMax: 5, values: [null, 0.6, 0.6, 1.3]},
                {name: "–ë–∞–∑–æ—Ñ–∏–ª—ã (%)", unit: "%", reference: "0 - 1.2", refMin: 0, refMax: 1.2, values: [null, 0.9, 0.6, 0.8]},
                {name: "–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã (PLT)", unit: "x10^9/L", reference: "180 - 320", refMin: 180, refMax: 320, values: [null, 215, 220, 220]},
                {name: "–°–û–≠", unit: "–º–º/—á", reference: "2 - 30", refMin: 2, refMax: 30, values: [null, 33, 22, 15]},
            ],
            biochem: [
                {name: "–ë–∏–ª–∏—Ä—É–±–∏–Ω –æ–±—â–∏–π", unit: "–º–∫–º–æ–ª—å/–ª", reference: "0 - 19", refMin: 0, refMax: 19, values: [4.9, 6.3, 6.1, 6.1]},
                {name: "–ë–∏–ª–∏—Ä—É–±–∏–Ω –ø—Ä—è–º–æ–π", unit: "¬µmol/L", reference: "0 - 5", refMin: 0, refMax: 5, values: [1.66, 2.38, 0.86, 2.17]},
                {name: "–ë–∏–ª–∏—Ä—É–±–∏–Ω –Ω–µ–ø—Ä—è–º–æ–π", unit: "¬µmol/L", reference: "0 - 14", refMin: 0, refMax: 14, values: [3.24, 3.92, 5.24, 3.93]},
                {name: "–û–±—â–∏–π –±–µ–ª–æ–∫", unit: "g/L", reference: "64 - 82", refMin: 64, refMax: 82, values: [60, 59, 62, 63]},
                {name: "–ê–ª—å–±—É–º–∏–Ω", unit: "–≥/–ª", reference: "35 - 52", refMin: 35, refMax: 52, values: [31, 28, 32, 35]},
                {name: "–ì–ª—é–∫–æ–∑–∞", unit: "–º–º–æ–ª—å/–ª", reference: "4.1 - 6.1", refMin: 4.1, refMax: 6.1, values: [4.1, 3.8, 4.0, 4.6]},
                {name: "–ê–õ–¢", unit: "U/L", reference: "0 - 33", refMin: 0, refMax: 33, values: [17, 38, 62, 37]},
                {name: "–ê–°–¢", unit: "U/l", reference: "0 - 32", refMin: 0, refMax: 32, values: [53, 273, 118, 49]},
                {name: "–ì–ì–¢", unit: "U/L", reference: "6 - 42", refMin: 6, refMax: 42, values: [20, 60, 109, 91]},
                {name: "–õ–î–ì", unit: "U/l", reference: "81 - 234", refMin: 81, refMax: 234, values: [275, 370, 276, 211]},
                {name: "–ú–æ—á–µ–≤–∏–Ω–∞", unit: "–º–∫–º–æ–ª—å/–ª", reference: "2.5 - 6.4", refMin: 2.5, refMax: 6.4, values: [4.6, 4.0, 4.3, 6.0]},
                {name: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω", unit: "¬µmol/L", reference: "44 - 80", refMin: 44, refMax: 80, values: [78.24, 88.84, 85.91, 77.61]},
                {name: "–ú–æ—á–µ–≤–∞—è –∫–∏—Å–ª–æ—Ç–∞", unit: "mg/dl", reference: "2.4 - 5.7", refMin: 2.4, refMax: 5.7, values: [4.58, 6.35, 5.92, 5.44]},
                {name: "–©–µ–ª–æ—á–Ω–∞—è —Ñ–æ—Å—Ñ–æ—Ç–∞–∑–∞", unit: "U/l", reference: "35 - 105", refMin: 35, refMax: 105, values: [43, 60, 61, 50]},
                {name: "–ê–ª—å—Ñ–∞-–ê–º–∏–ª–∞–∑–∞", unit: "U/L", reference: "28 - 100", refMin: 28, refMax: 100, values: [32, 27, 38, 44]},
                {name: "–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω", unit: "¬µmol/L", reference: "0 - 5.2", refMin: 0, refMax: 5.2, values: [3.6, 3.2, 4.4, 5.4]},
                {name: "–¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥—ã", unit: "¬µmol/L", reference: "0 - 2.25", refMin: 0, refMax: 2.25, values: [2.70, 2.08, 3.36, 2.66]},
                {name: "–ö–∞–ª—å—Ü–∏–π", unit: "¬µmol/L", reference: "2.15 - 2.5", refMin: 2.15, refMax: 2.5, values: [2.15, 2.11, 2.14, 2.19]},
                {name: "–§–æ—Å—Ñ–æ—Ä", unit: "mmol/l", reference: "0.84 - 1.52", refMin: 0.84, refMax: 1.52, values: [1.38, 1.39, 1.21, 1.41]},
                {name: "–ñ–µ–ª–µ–∑–æ", unit: "¬µmol/L", reference: "6.6 - 26", refMin: 6.6, refMax: 26, values: [11.9, 12.4, 20.7, 18.3]},
                {name: "–°-—Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–π –±–µ–ª–æ–∫", unit: "mg/l", reference: "0 - 9", refMin: 0, refMax: 9, values: [21.27, 25.47, 5.38, 6.12]},
            ],
            immuno: [
                {name: "–ò–Ω—Ç–µ—Ä–ª–µ–π–∫–∏–Ω-6", unit: "–ø–≥/–º–ª", reference: "0 - 7", refMin: 0, refMax: 7, values: [52, 41.5, 29.8, 18.3]},
            ]
        };
        
        function isOutOfRange(value, refMin, refMax) {
            if (value === null) return false;
            return value < refMin || value > refMax;
        }
        
        function calculateChange(val1, val2) {
            if (val1 === null || val2 === null) return null;
            return ((val2 - val1) / val1 * 100).toFixed(1);
        }
        
        function getTrendGroup(test) {
            const validValues = test.values.filter(v => v !== null);
            if (validValues.length < 2) return 'stable';
            
            const firstVal = validValues[0];
            const lastVal = validValues[validValues.length - 1];
            const change = calculateChange(firstVal, lastVal);
            
            if (change === null) return 'stable';
            
            const absChange = Math.abs(parseFloat(change));
            const changeNum = parseFloat(change);
            const isOutNorm = isOutOfRange(lastVal, test.refMin, test.refMax);
            const wasOutNorm = isOutOfRange(firstVal, test.refMin, test.refMax);
            
            if (absChange < 10) return 'stable';
            
            if (changeNum > 0) {
                if (isOutNorm && absChange > 30) return 'critical';
                else if (isOutNorm && absChange > 15) return 'warning';
                else return 'stable';
            } else {
                if (wasOutNorm && absChange > 20) return 'improving';
                else return 'stable';
            }
        }
        
        function getTrendDescription(test) {
            const validValues = test.values.filter(v => v !== null);
            if (validValues.length < 2) return "‚ö™ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö";
            
            const firstVal = validValues[0];
            const lastVal = validValues[validValues.length - 1];
            const change = calculateChange(firstVal, lastVal);
            
            if (change === null) return "‚ö™ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
            
            const absChange = Math.abs(parseFloat(change));
            const changeNum = parseFloat(change);
            
            let icon = "";
            let trend = "";
            
            if (absChange < 10) {
                icon = "‚û°Ô∏è";
                trend = "–°—Ç–∞–±–∏–ª—å–Ω–æ";
            } else if (changeNum > 0) {
                icon = "üìà";
                const isOutOfNorm = lastVal > test.refMax || lastVal < test.refMin;
                if (isOutOfNorm && absChange > 50) {
                    trend = `<strong style="color: #dc2626;">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–æ—Å—Ç ${change}%</strong>`;
                } else if (isOutOfNorm) {
                    trend = `<strong style="color: #dc2626;">–†–æ—Å—Ç ${change}%</strong>`;
                } else {
                    trend = `–†–æ—Å—Ç ${change}%`;
                }
            } else {
                icon = "üìâ";
                const wasOutOfNorm = firstVal > test.refMax || firstVal < test.refMin;
                if (wasOutOfNorm && !isOutOfRange(lastVal, test.refMin, test.refMax)) {
                    trend = `<strong style="color: #059669;">–°–Ω–∏–∂–µ–Ω–∏–µ ${Math.abs(change)}% ‚úì –ù–æ—Ä–º–∞</strong>`;
                } else if (wasOutOfNorm) {
                    trend = `<strong style="color: #059669;">–°–Ω–∏–∂–µ–Ω–∏–µ ${Math.abs(change)}%</strong>`;
                } else {
                    trend = `–°–Ω–∏–∂–µ–Ω–∏–µ ${Math.abs(change)}%`;
                }
            }
            
            return `<span class="trend-icon">${icon}</span><span>${trend}</span>`;
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –≥—Ä—É–ø–ø–∞–º–∏
        const globalGroups = [
            { id: 'oak', title: 'ü©∏ –û–ê–ö (–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏)', desc: '27 –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π', icon: 'ü©∏', tests: allTests.oak },
            { id: 'biochem', title: '‚öóÔ∏è –ë–∏–æ—Ö–∏–º–∏—è', desc: '22 –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è', icon: '‚öóÔ∏è', tests: allTests.biochem },
            { id: 'immuno', title: 'üõ°Ô∏è –ò–º–º—É–Ω–æ–ª–æ–≥–∏—è', desc: '1 –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å', icon: 'üõ°Ô∏è', tests: allTests.immuno }
        ];
        
        const mainContent = document.getElementById('mainContent');
        let chartIndex = 0;
        
        globalGroups.forEach(globalGroup => {
            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –≥—Ä—É–ø–ø—ã
            const subGroups = { critical: [], warning: [], improving: [], stable: [] };
            
            globalGroup.tests.forEach(test => {
                test.chartIndex = chartIndex++;
                const group = getTrendGroup(test);
                subGroups[group].push(test);
            });
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –≥—Ä—É–ø–ø—ã
            const globalSection = document.createElement('div');
            globalSection.className = 'global-group';
            
            const globalHeader = document.createElement('div');
            globalHeader.className = 'global-header';
            globalHeader.innerHTML = `
                <div class="global-title" style="flex: 1;">
                    <h2>${globalGroup.title}</h2>
                    <p>${globalGroup.desc}</p>
                </div>
                <div class="global-count">${globalGroup.tests.length}</div>
                <div class="toggle-icon expanded">‚ñº</div>
            `;
            
            const globalContent = document.createElement('div');
            globalContent.className = 'global-content';
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–≥—Ä—É–ø–ø
            const subGroupConfigs = [
                { id: 'critical', title: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É—Ö—É–¥—à–µ–Ω–∏–µ', icon: 'üî¥', desc: '–¢—Ä–µ–±—É—é—Ç —Å—Ä–æ—á–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è' },
                { id: 'warning', title: '–£–º–µ—Ä–µ–Ω–Ω–æ–µ —É—Ö—É–¥—à–µ–Ω–∏–µ', icon: '‚ö†Ô∏è', desc: '–¢—Ä–µ–±—É—é—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è' },
                { id: 'improving', title: '–£–ª—É—á—à–µ–Ω–∏–µ', icon: '‚úÖ', desc: '–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞' },
                { id: 'stable', title: '–°—Ç–∞–±–∏–ª—å–Ω—ã–µ', icon: '‚û°Ô∏è', desc: '–ë–µ–∑ –∑–Ω–∞—á–∏–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π' }
            ];
            
            subGroupConfigs.forEach(subConfig => {
                if (subGroups[subConfig.id].length === 0) return;
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –≤–Ω–µ –Ω–æ—Ä–º—ã (–∫—Ä–∞—Å–Ω—ã–µ), –ø–æ—Ç–æ–º –≤ –Ω–æ—Ä–º–µ (–∑–µ–ª—ë–Ω—ã–µ)
                if (subConfig.id === 'stable') {
                    subGroups[subConfig.id].sort((a, b) => {
                        const aLastVal = a.values.filter(v => v !== null).pop();
                        const bLastVal = b.values.filter(v => v !== null).pop();
                        const aOutOfRange = isOutOfRange(aLastVal, a.refMin, a.refMax);
                        const bOutOfRange = isOutOfRange(bLastVal, b.refMin, b.refMax);
                        return bOutOfRange - aOutOfRange; // true (1) –∏–¥—ë—Ç –ø–µ—Ä–≤—ã–º
                    });
                }
                
                const subSection = document.createElement('div');
                subSection.className = 'sub-group';
                
                const subHeader = document.createElement('div');
                subHeader.className = `sub-header ${subConfig.id}`;
                subHeader.innerHTML = `
                    <div class="sub-icon">${subConfig.icon}</div>
                    <div class="sub-title">
                        <h3>${subConfig.title}</h3>
                        <p>${subConfig.desc}</p>
                    </div>
                    <div class="sub-count ${subConfig.id}">${subGroups[subConfig.id].length}</div>
                    <div class="toggle-icon expanded">‚ñº</div>
                `;
                
                const subContent = document.createElement('div');
                subContent.className = 'sub-content';
                
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
                            <th>–ù–æ—Ä–º–∞</th>
                            <th style="text-align: center;">26.09</th>
                            <th style="text-align: center;">08.10</th>
                            <th style="text-align: center;">15.10</th>
                            <th style="text-align: center;">28.10</th>
                            <th>–î–∏–Ω–∞–º–∏–∫–∞</th>
                            <th>–ì—Ä–∞—Ñ–∏–∫</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                subGroups[subConfig.id].forEach(test => {
                    const row = document.createElement('tr');
                    
                    let valuesHTML = '';
                    test.values.forEach((val, idx) => {
                        if (val === null) {
                            valuesHTML += '<td class="value-cell">-</td>';
                        } else {
                            const outRange = isOutOfRange(val, test.refMin, test.refMax);
                            const changeFromPrev = idx > 0 ? calculateChange(test.values[idx-1], val) : null;
                            
                            let changeBadge = '';
                            if (changeFromPrev !== null && Math.abs(parseFloat(changeFromPrev)) >= 5) {
                                const changeClass = parseFloat(changeFromPrev) > 0 ? 'up' : 'down';
                                const arrow = parseFloat(changeFromPrev) > 0 ? '‚Üë' : '‚Üì';
                                changeBadge = `<span class="change-badge ${changeClass}">${arrow}${Math.abs(changeFromPrev)}%</span>`;
                            }
                            
                            valuesHTML += `<td class="value-cell ${outRange ? 'out-of-range' : 'in-range'}">${val} ${test.unit}<br>${changeBadge}</td>`;
                        }
                    });
                    
                    row.innerHTML = `
                        <td class="test-name">${test.name}</td>
                        <td class="reference">${test.reference}</td>
                        ${valuesHTML}
                        <td class="trend-cell">${getTrendDescription(test)}</td>
                        <td style="text-align: center;">
                            <canvas class="chart-mini" id="chart${test.chartIndex}"></canvas>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                    
                    // –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–∞
                    setTimeout(() => {
                        const ctx = document.getElementById(`chart${test.chartIndex}`);
                        if (!ctx) return;
                        
                        const validValues = test.values.filter(v => v !== null);
                        const validLabels = test.values.map((v, i) => v !== null ? ['26.09', '08.10', '15.10', '28.10'][i] : null).filter(l => l !== null);
                        
                        const lastVal = test.values[test.values.length - 1];
                        const lineColor = isOutOfRange(lastVal, test.refMin, test.refMax) ? '#ef4444' : '#10b981';
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: validLabels,
                                datasets: [{
                                    data: validValues,
                                    borderColor: lineColor,
                                    backgroundColor: lineColor + '20',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 2,
                                    pointHoverRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                                scales: { x: { display: false }, y: { display: false } },
                                events: []
                            }
                        });
                        
                        ctx.style.cursor = 'pointer';
                        ctx.onclick = () => openModal(test);
                    }, 200);
                });
                
                subContent.appendChild(table);
                subSection.appendChild(subHeader);
                subSection.appendChild(subContent);
                globalContent.appendChild(subSection);
                
                // Toggle –¥–ª—è –ø–æ–¥–≥—Ä—É–ø–ø—ã
                subHeader.onclick = () => {
                    const icon = subHeader.querySelector('.toggle-icon');
                    if (subContent.classList.contains('collapsed')) {
                        subContent.classList.remove('collapsed');
                        subContent.style.maxHeight = subContent.scrollHeight + 'px';
                        icon.classList.add('expanded');
                    } else {
                        subContent.classList.add('collapsed');
                        subContent.style.maxHeight = '0';
                        icon.classList.remove('expanded');
                    }
                };
                
                setTimeout(() => { subContent.style.maxHeight = subContent.scrollHeight + 'px'; }, 100);
            });
            
            globalSection.appendChild(globalHeader);
            globalSection.appendChild(globalContent);
            mainContent.appendChild(globalSection);
            
            // Toggle –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π –≥—Ä—É–ø–ø—ã
            globalHeader.onclick = () => {
                const icon = globalHeader.querySelector('.toggle-icon');
                if (globalContent.classList.contains('collapsed')) {
                    globalContent.classList.remove('collapsed');
                    globalContent.style.maxHeight = '10000px';
                    icon.classList.add('expanded');
                } else {
                    globalContent.classList.add('collapsed');
                    globalContent.style.maxHeight = '0';
                    icon.classList.remove('expanded');
                }
            };
        });
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        let currentChart = null;
        function openModal(test) {
            const modal = document.getElementById('chartModal');
            const title = document.getElementById('modalTitle');
            const ctx = document.getElementById('modalChart').getContext('2d');
            
            modal.style.display = 'block';
            title.textContent = test.name;
            
            if (currentChart) currentChart.destroy();
            
            const validValues = test.values.filter(v => v !== null);
            const validLabels = test.values.map((v, i) => v !== null ? ['26.09.2025', '08.10.2025', '15.10.2025', '28.10.2025'][i] : null).filter(l => l !== null);
            const lastVal = test.values[test.values.length - 1];
            const lineColor = isOutOfRange(lastVal, test.refMin, test.refMax) ? '#ef4444' : '#10b981';
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: validLabels,
                    datasets: [
                        { label: '–ó–Ω–∞—á–µ–Ω–∏–µ', data: validValues, borderColor: lineColor, backgroundColor: lineColor + '30', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 6 },
                        { label: '–í–µ—Ä—Ö–Ω—è—è –Ω–æ—Ä–º–∞', data: Array(validLabels.length).fill(test.refMax), borderColor: '#ef4444', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, fill: false },
                        { label: '–ù–∏–∂–Ω—è—è –Ω–æ—Ä–º–∞', data: Array(validLabels.length).fill(test.refMin), borderColor: '#ef4444', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + ctx.parsed.y + ' ' + test.unit } }
                    },
                    scales: { y: { beginAtZero: false, ticks: { callback: (val) => val + ' ' + test.unit } } }
                }
            });
        }
        
        document.querySelector('.close-modal').onclick = () => document.getElementById('chartModal').style.display = 'none';
        window.onclick = (e) => { if (e.target.id === 'chartModal') e.target.style.display = 'none'; };
    </script>
</body>
</html>